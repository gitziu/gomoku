<html>
    <head>
        <link rel="stylesheet" href="/static/style.css">
        <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="userlist">
            Hello <span id="username" class="you"></span>.
            <ul id="userlist">
            </ul>
        </div>
        <div class="board">
            <div id="gamename"></div>
            <table class="board">
                <script>
                    for(let row = 0; row < 19; ++row) {
                        document.write("<tr>");
                        for(let col = 0; col < 19; ++col) {
                            document.write("<td id='board-"+ row + "-" + col + "'></td>")
                        }
                        document.write("</tr>");
                    }
                </script>
            </table>
        </div>
        <div class="gamelist">
            <ul id="gamelist">
            </ul>
        </div>
        <span id="error" class="error"></span>
    </body>
    <script>
        const token = new URLSearchParams(window.location.search).get('token');
        let currentGameId = "";
        let games = {};

        function refreshBoard(){
            const game = games[currentGameId];
            if(!game) {
                $("#gamename").text("");
                return;
            }
            $("#gamename").text(game.player1 + " vs " + game.player2)
        }

        function selectUser(username) {
            console.log(`Selected to play with ${username}`);
            $.ajax({
                type: "POST",
                url: "/games?token=" + token,
                data: {username},
                success: function(response) {
                    if(response.error) {
                        $("#error").text(response.error);
                        return;
                    }
                    currentGameId = response.gameId;
                    listGames(response.games);
                    refreshBoard();
                }
            })
        }

        function selectGame(id) {
            console.log(`Selected to see game ${id}`);
            currentGameId = id;
            refreshBoard();
        }

        function refreshUsers() {
            $.ajax({
                type: "GET",
                url: "/users?token=" + token,
                success: function(response) {
                    if(response.error) {
                        $("#error").text(response.error);
                        return;
                    }
                    $("#username").text(response.you);
                    const ul = $("#userlist");
                    ul.empty();
                    for(const user of response.users) {
                        ul.append(
                            $("<li>").append(
                                $("<a>").text(user).click(function () {selectUser(user)})
                            )
                        );
                    }
                }
            });
        }

        function listGames(gameData) {
            const ul = $("#gamelist");
            ul.empty();
            games = gameData || {};
            for(const game of Object.values(games)) {
                        ul.append(
                            $("<li>").append(
                                $("<a>").text(game.player1 + " vs " + game.player2).click(function() {selectGame(game.id)})
                            )
                        );
                    }
        }

        function refreshGames() {
            $.ajax({
                type: "GET",
                url: "/games?token=" + token,
                success: function(response) {
                    if(response.error) {
                        $("#error").text(response.error);
                        return;
                    }
                    listGames(response.games);
                }
            });
        }

        refreshUsers();
        refreshGames();
    </script>
</html>
